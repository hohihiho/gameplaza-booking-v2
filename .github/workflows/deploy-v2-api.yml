name: Deploy v2 API with Canary

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment type'
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - full
          - rollback
      canary_percentage:
        description: 'Canary traffic percentage (0-100)'
        required: false
        default: '10'
        type: string

  push:
    branches:
      - main
    paths:
      - 'app/api/v2/**'
      - 'lib/api/v2/**'
      - 'middleware.ts'

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

      - name: Run unit tests
        run: npm test -- --testPathPattern="app/api/v2" --coverage

      - name: Run integration tests
        run: npm test -- --testPathPattern="__tests__/integration" --runInBand
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  performance-test:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        run: npm test -- --testPathPattern="__tests__/performance" --runInBand
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: Check performance thresholds
        run: |
          # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²€ì¦
          if [ -f "performance-results.json" ]; then
            p95=$(jq '.p95' performance-results.json)
            if (( $(echo "$p95 > 200" | bc -l) )); then
              echo "âŒ Performance threshold exceeded: p95=$p95ms (limit: 200ms)"
              exit 1
            fi
            echo "âœ… Performance check passed: p95=$p95ms"
          fi

  deploy-canary:
    name: Deploy Canary
    runs-on: ubuntu-latest
    needs: [test, performance-test]
    if: github.event.inputs.deployment_type != 'rollback'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel (Canary)
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export CANARY_PERCENTAGE=${{ github.event.inputs.canary_percentage || '10' }}
          export FEATURE_FLAG_V2_API=true
          export CANARY_DEPLOYMENT=true
          
          # Vercel ë°°í¬
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
          echo "Deployed to: $DEPLOYMENT_URL"

      - name: Update Edge Config
        run: |
          # Canary ë°°í¬ ì„¤ì • ì—…ë°ì´íŠ¸
          curl -X PATCH "https://api.vercel.com/v1/edge-config/${{ secrets.EDGE_CONFIG_ID }}/items" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "items": [
                {
                  "key": "v2-api-canary",
                  "value": {
                    "enabled": true,
                    "percentage": ${{ github.event.inputs.canary_percentage || "10" }},
                    "deploymentUrl": "'$DEPLOYMENT_URL'",
                    "startTime": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
                  }
                }
              ]
            }'

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy-canary
    steps:
      - uses: actions/checkout@v4

      - name: Check API Health
        run: |
          # Health check ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh "${{ env.DEPLOYMENT_URL }}"

      - name: Monitor Error Rate
        run: |
          # ì´ˆê¸° ì—ëŸ¬ìœ¨ ëª¨ë‹ˆí„°ë§ (5ë¶„ê°„)
          echo "Monitoring error rate for 5 minutes..."
          sleep 300
          
          # Vercel Analytics APIë¥¼ í†µí•œ ì—ëŸ¬ìœ¨ í™•ì¸
          ERROR_RATE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v6/deployments/${{ env.DEPLOYMENT_URL }}/metrics?metric=errorRate&from=-5m" | \
            jq '.data.errorRate')
          
          if (( $(echo "$ERROR_RATE > 1" | bc -l) )); then
            echo "âŒ Error rate too high: $ERROR_RATE%"
            exit 1
          fi
          echo "âœ… Error rate acceptable: $ERROR_RATE%"

  gradual-rollout:
    name: Gradual Rollout
    runs-on: ubuntu-latest
    needs: health-check
    if: github.event.inputs.deployment_type == 'canary'
    strategy:
      matrix:
        percentage: [25, 50, 75, 100]
    steps:
      - name: Increase Canary Traffic
        run: |
          echo "Increasing canary traffic to ${{ matrix.percentage }}%"
          
          # Edge Config ì—…ë°ì´íŠ¸
          curl -X PATCH "https://api.vercel.com/v1/edge-config/${{ secrets.EDGE_CONFIG_ID }}/items" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "items": [
                {
                  "key": "v2-api-canary",
                  "value": {
                    "enabled": true,
                    "percentage": ${{ matrix.percentage }},
                    "deploymentUrl": "'${{ env.DEPLOYMENT_URL }}'",
                    "lastUpdated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
                  }
                }
              ]
            }'

      - name: Monitor Metrics
        run: |
          # ê° ë‹¨ê³„ë³„ 10ë¶„ê°„ ëª¨ë‹ˆí„°ë§
          echo "Monitoring at ${{ matrix.percentage }}% for 10 minutes..."
          sleep 600
          
          # ë©”íŠ¸ë¦­ ì²´í¬
          chmod +x scripts/monitor-metrics.sh
          ./scripts/monitor-metrics.sh "${{ env.DEPLOYMENT_URL }}" "${{ matrix.percentage }}"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_type == 'rollback' || failure()
    steps:
      - name: Disable Canary
        run: |
          echo "ğŸ”„ Rolling back deployment..."
          
          # Canary ë¹„í™œì„±í™”
          curl -X PATCH "https://api.vercel.com/v1/edge-config/${{ secrets.EDGE_CONFIG_ID }}/items" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "items": [
                {
                  "key": "v2-api-canary",
                  "value": {
                    "enabled": false,
                    "percentage": 0,
                    "rollbackTime": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
                  }
                }
              ]
            }'

      - name: Notify Rollback
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ v2 API ë°°í¬ ë¡¤ë°±ë¨',
              body: `v2 API ë°°í¬ê°€ ìë™ìœ¼ë¡œ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n**ì‹œê°„**: ${new Date().toISOString()}\n**ì›ì¸**: ${context.job === 'rollback' ? 'ìˆ˜ë™ ë¡¤ë°±' : 'ìë™ ë¡¤ë°± (í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨)'}\n\n[ì›Œí¬í”Œë¡œìš° í™•ì¸](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            })

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: always()
    needs: [deploy-canary, health-check, gradual-rollout]
    steps:
      - name: Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="ì‹¤íŒ¨"
          COLOR="danger"
          if [ "${{ needs.gradual-rollout.result }}" == "success" ]; then
            STATUS="ì„±ê³µ"
            COLOR="good"
          fi
          
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{
              "attachments": [{
                "color": "'$COLOR'",
                "title": "v2 API ë°°í¬ '$STATUS'",
                "fields": [
                  {"title": "ë°°í¬ íƒ€ì…", "value": "${{ github.event.inputs.deployment_type }}", "short": true},
                  {"title": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "short": true},
                  {"title": "ì»¤ë°‹", "value": "${{ github.sha }}", "short": false}
                ]
              }]
            }'