name: ðŸŒ™ Nightly Comprehensive Tests

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (KST 11ì‹œ)ì— ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  NODE_VERSION: '18'

jobs:
  # ì „ì²´ íšŒê·€ í…ŒìŠ¤íŠ¸
  full-regression-tests:
    name: ðŸ”„ Full Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps
        
      - name: ðŸ—ï¸ Build application
        run: npm run build
        
      - name: ðŸš€ Start application
        run: npm start &
        env:
          NODE_ENV: test
          
      - name: â³ Wait for application
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:3000; do sleep 5; done'
          
      - name: ðŸ§ª Run all unit tests
        run: npm run test:coverage
        
      - name: ðŸŽ­ Run complete E2E test suite
        run: npx playwright test --project=chromium --project=firefox --project=webkit
        
      - name: ðŸ“± Run mobile tests on all devices
        run: |
          npx playwright test --project="iPhone 12"
          npx playwright test --project="Galaxy S21"
          npx playwright test --project="iPad Pro"
          
      - name: ðŸ“Š Generate comprehensive report
        run: |
          mkdir -p nightly-reports
          echo "# ðŸŒ™ Nightly Test Report - $(date '+%Y-%m-%d')" > nightly-reports/summary.md
          echo "" >> nightly-reports/summary.md
          
          # ì»¤ë²„ë¦¬ì§€ ì •ë³´
          if [ -f coverage/coverage-summary.json ]; then
            LINES_PCT=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            FUNCTIONS_PCT=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')
            BRANCHES_PCT=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
            STATEMENTS_PCT=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
            
            echo "## ðŸ“Š Coverage Metrics" >> nightly-reports/summary.md
            echo "- Lines: $LINES_PCT%" >> nightly-reports/summary.md
            echo "- Functions: $FUNCTIONS_PCT%" >> nightly-reports/summary.md
            echo "- Branches: $BRANCHES_PCT%" >> nightly-reports/summary.md
            echo "- Statements: $STATEMENTS_PCT%" >> nightly-reports/summary.md
            echo "" >> nightly-reports/summary.md
          fi
          
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
          echo "## ðŸ§ª Test Results" >> nightly-reports/summary.md
          echo "- Unit Tests: $(npm run test 2>&1 | grep -c 'PASS\|FAIL' || echo 'N/A')" >> nightly-reports/summary.md
          echo "- E2E Tests: All browsers completed" >> nightly-reports/summary.md
          echo "- Mobile Tests: All devices completed" >> nightly-reports/summary.md
          echo "" >> nightly-reports/summary.md
          
      - name: ðŸ“Š Upload nightly report
        uses: actions/upload-artifact@v3
        with:
          name: nightly-test-report-${{ github.run_number }}
          path: |
            nightly-reports/
            coverage/
            test-results/
            playwright-report/
          retention-days: 30

  # ë¶€í•˜ í…ŒìŠ¤íŠ¸
  load-tests:
    name: ðŸš€ Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ“Š Install load testing tools
        run: |
          npm install -g artillery autocannon
          
      - name: ðŸ—ï¸ Build application
        run: npm run build
        
      - name: ðŸš€ Start application
        run: npm start &
        env:
          NODE_ENV: production
          
      - name: â³ Wait for application
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
          
      - name: ðŸŽ¯ Run load tests
        run: |
          # Artilleryë¥¼ ì‚¬ìš©í•œ ë¶€í•˜ í…ŒìŠ¤íŠ¸
          cat > load-test-config.yml << EOF
          config:
            target: 'http://localhost:3000'
            phases:
              - duration: 60
                arrivalRate: 10
              - duration: 120
                arrivalRate: 50
              - duration: 60
                arrivalRate: 10
            payload:
              path: './users.csv'
              fields:
                - 'email'
          scenarios:
            - name: "Homepage Load"
              weight: 30
              flow:
                - get:
                    url: "/"
            - name: "Reservations Page"
              weight: 40
              flow:
                - get:
                    url: "/reservations"
            - name: "New Reservation"
              weight: 20
              flow:
                - get:
                    url: "/reservations/new"
            - name: "API Endpoints"
              weight: 10
              flow:
                - get:
                    url: "/api/v2/devices"
                - get:
                    url: "/api/v2/reservations"
          EOF
          
          # ë”ë¯¸ ì‚¬ìš©ìž ë°ì´í„° ìƒì„±
          echo "email" > users.csv
          for i in {1..100}; do echo "user$i@test.com" >> users.csv; done
          
          # ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          artillery run load-test-config.yml --output load-test-results.json
          
      - name: ðŸ“ˆ Generate load test report
        run: |
          artillery report load-test-results.json --output load-test-report.html
          
          # ê¸°ë³¸ ì„±ëŠ¥ ê²€ì¦
          MEDIAN_RESPONSE=$(cat load-test-results.json | jq '.aggregate.latency.median')
          P95_RESPONSE=$(cat load-test-results.json | jq '.aggregate.latency.p95')
          ERROR_RATE=$(cat load-test-results.json | jq '.aggregate.counters["errors.ECONNREFUSED"] // 0')
          
          echo "Median Response Time: ${MEDIAN_RESPONSE}ms"
          echo "P95 Response Time: ${P95_RESPONSE}ms"
          echo "Error Count: $ERROR_RATE"
          
          # ì„±ëŠ¥ ê¸°ì¤€ ì²´í¬
          if (( $(echo "$MEDIAN_RESPONSE > 500" | bc -l) )); then
            echo "âš ï¸ Median response time $MEDIAN_RESPONSE ms exceeds 500ms threshold"
          fi
          
          if (( $(echo "$P95_RESPONSE > 2000" | bc -l) )); then
            echo "âš ï¸ P95 response time $P95_RESPONSE ms exceeds 2000ms threshold"
          fi
          
      - name: ðŸ“Š Upload load test results
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: |
            load-test-results.json
            load-test-report.html
          retention-days: 30

  # ë³´ì•ˆ ìŠ¤ìº” (ì‹¬í™”)
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ” Run npm audit
        run: |
          npm audit --audit-level=low --json > npm-audit-results.json || true
          
      - name: ðŸ›¡ï¸ Install and run ESLint security plugin
        run: |
          npm install --no-save eslint-plugin-security
          npx eslint . --ext .js,.jsx,.ts,.tsx --config .eslintrc.security.js || true
          
      - name: ðŸ” Check for secrets in code
        run: |
          # ê°„ë‹¨í•œ ì‹œí¬ë¦¿ íŒ¨í„´ ê²€ìƒ‰
          echo "Checking for potential secrets..."
          grep -r -E "(password|secret|key|token)" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" . || true
          
      - name: ðŸ“Š Generate security report
        run: |
          mkdir -p security-reports
          echo "# ðŸ”’ Security Audit Report - $(date)" > security-reports/summary.md
          echo "" >> security-reports/summary.md
          
          if [ -f npm-audit-results.json ]; then
            VULNERABILITIES=$(cat npm-audit-results.json | jq '.metadata.vulnerabilities.total // 0')
            echo "## NPM Audit Results" >> security-reports/summary.md
            echo "- Total vulnerabilities: $VULNERABILITIES" >> security-reports/summary.md
            echo "" >> security-reports/summary.md
          fi
          
      - name: ðŸ“Š Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: |
            security-reports/
            npm-audit-results.json
          retention-days: 90

  # ë°ì´í„°ë² ì´ìŠ¤ ë¬´ê²°ì„± í…ŒìŠ¤íŠ¸
  database-integrity:
    name: ðŸ—„ï¸ Database Integrity Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Install dependencies
        run: npm ci
        
      - name: ðŸ—„ï¸ Run database migrations
        run: |
          # Supabase CLIë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
          if [ -d "supabase/migrations" ]; then
            echo "Running database migrations..."
            # ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë¡œì§
          fi
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          
      - name: ðŸ§ª Run database integration tests
        run: |
          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          npm run test -- __tests__/integration/
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          
      - name: ðŸ“Š Generate database test report
        run: |
          echo "Database integrity tests completed successfully"

  # ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„± ë° ì•Œë¦¼
  nightly-summary:
    name: ðŸ“‹ Nightly Summary & Notification
    needs: [full-regression-tests, load-tests, security-audit, database-integrity]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v3
        
      - name: ðŸ“Š Generate comprehensive summary
        run: |
          mkdir -p final-reports
          
          cat > final-reports/nightly-summary.md << EOF
          # ðŸŒ™ Nightly Test Summary - $(date '+%Y-%m-%d')
          
          ## Job Results
          - Full Regression Tests: ${{ needs.full-regression-tests.result }}
          - Load Tests: ${{ needs.load-tests.result }}
          - Security Audit: ${{ needs.security-audit.result }}
          - Database Integrity: ${{ needs.database-integrity.result }}
          
          ## Quick Links
          - [Coverage Report](coverage/lcov-report/index.html)
          - [E2E Test Results](playwright-report/index.html)
          - [Load Test Report](load-test-report.html)
          - [Security Audit](security-reports/summary.md)
          
          ## Recommendations
          $([ "${{ needs.full-regression-tests.result }}" != "success" ] && echo "- ðŸš¨ Fix failing regression tests")
          $([ "${{ needs.load-tests.result }}" != "success" ] && echo "- âš¡ Review performance issues")
          $([ "${{ needs.security-audit.result }}" != "success" ] && echo "- ðŸ”’ Address security vulnerabilities")
          $([ "${{ needs.database-integrity.result }}" != "success" ] && echo "- ðŸ—„ï¸ Fix database integrity issues")
          
          Generated at: $(date)
          EOF
          
      - name: ðŸ“Š Upload final summary
        uses: actions/upload-artifact@v3
        with:
          name: nightly-summary-${{ github.run_number }}
          path: final-reports/
          retention-days: 90
          
      - name: ðŸš¨ Send notification on failure
        if: |
          needs.full-regression-tests.result == 'failure' ||
          needs.load-tests.result == 'failure' ||
          needs.security-audit.result == 'failure' ||
          needs.database-integrity.result == 'failure'
        run: |
          echo "ðŸš¨ Nightly tests failed!"
          echo "Check the workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack/Discord ì•Œë¦¼ ì „ì†¡ (ì„ íƒì‚¬í•­)
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ðŸŒ™ Nightly tests failed! Check details at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: âœ… Send success notification
        if: |
          needs.full-regression-tests.result == 'success' &&
          needs.load-tests.result == 'success' &&
          needs.security-audit.result == 'success' &&
          needs.database-integrity.result == 'success'
        run: |
          echo "âœ… All nightly tests passed!"
          echo "Summary available at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"