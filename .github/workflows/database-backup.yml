name: ðŸ—„ï¸ Database Backup (Production Only)

on:
  # í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œë§Œ ìŠ¤ì¼€ì¤„ ì‹¤í–‰
  # schedule:
  #   - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ ì£¼ì„ í•´ì œ)
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'ë°±ì—… ìœ í˜•'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - json
          - sql
          - schema
      
      retention_days:
        description: 'ë°±ì—… ë³´ê´€ ì¼ìˆ˜'
        required: true
        default: '30'
        type: string

env:
  NODE_VERSION: '18'
  BACKUP_REPO: 'gameplaza-backups' # ë°±ì—… ì „ìš© ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„

jobs:
  backup:
    name: ðŸš€ Database Backup
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Checkout ì†ŒìŠ¤ì½”ë“œ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci --only=production
          npm install @supabase/supabase-js dotenv
      
      - name: ðŸ” í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
      
      - name: ðŸ“Š ë°±ì—… ì „ ìƒíƒœ í™•ì¸
        run: |
          echo "=== ë°±ì—… ì‹œìž‘ ì •ë³´ ===" 
          echo "ì‹œìž‘ ì‹œê°„: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "í•œêµ­ ì‹œê°„: $(TZ=Asia/Seoul date +"%Y-%m-%d %H:%M:%S KST")"
          echo "ë°±ì—… ìœ í˜•: ${{ github.event.inputs.backup_type || 'full' }}"
          echo "ë³´ê´€ ì¼ìˆ˜: ${{ github.event.inputs.retention_days || '30' }}"
          echo "ì›Œí¬í”Œë¡œìš°: ${{ github.event_name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Node ë²„ì „: $(node --version)"
          echo "npm ë²„ì „: $(npm --version)"
      
      - name: ðŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹¤í–‰
        id: backup
        run: |
          BACKUP_TYPE="${{ github.event.inputs.backup_type || 'full' }}"
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          
          echo "backup_timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "backup_type=${BACKUP_TYPE}" >> $GITHUB_OUTPUT
          
          # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p backups/{json,sql,logs}
          
          # ë°±ì—… ì‹¤í–‰
          echo "ðŸš€ ${BACKUP_TYPE} ë°±ì—… ì‹œìž‘..."
          
          if [[ "$BACKUP_TYPE" == "full" ]]; then
            node scripts/backup-database.js full 2>&1 | tee "backups/logs/backup-${TIMESTAMP}.log"
          else
            node scripts/backup-database.js "$BACKUP_TYPE" 2>&1 | tee "backups/logs/backup-${TIMESTAMP}.log"
          fi
          
          # ë°±ì—… ê²°ê³¼ í™•ì¸
          if [ $? -eq 0 ]; then
            echo "âœ… ë°±ì—… ì„±ê³µ"
            echo "backup_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ë°±ì—… ì‹¤íŒ¨"
            echo "backup_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ðŸ“ˆ ë°±ì—… íŒŒì¼ ì •ë³´ ìˆ˜ì§‘
        id: backup_info
        run: |
          echo "=== ë°±ì—… íŒŒì¼ ì •ë³´ ===" 
          
          TOTAL_SIZE=0
          FILE_COUNT=0
          BACKUP_FILES=""
          
          # JSON ë°±ì—… íŒŒì¼ í™•ì¸
          if [ -d "backups/json" ] && [ "$(ls -A backups/json)" ]; then
            echo "ðŸ“„ JSON ë°±ì—… íŒŒì¼:"
            for file in backups/json/*; do
              if [ -f "$file" ]; then
                size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
                size_mb=$(( size / 1024 / 1024 ))
                echo "  - $(basename "$file"): ${size_mb}MB"
                TOTAL_SIZE=$(( TOTAL_SIZE + size ))
                FILE_COUNT=$(( FILE_COUNT + 1 ))
                BACKUP_FILES="${BACKUP_FILES}$(basename "$file") (${size_mb}MB)\n"
              fi
            done
          fi
          
          # SQL ë°±ì—… íŒŒì¼ í™•ì¸
          if [ -d "backups/sql" ] && [ "$(ls -A backups/sql)" ]; then
            echo "ðŸ—ƒï¸ SQL ë°±ì—… íŒŒì¼:"
            for file in backups/sql/*; do
              if [ -f "$file" ]; then
                size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
                size_mb=$(( size / 1024 / 1024 ))
                echo "  - $(basename "$file"): ${size_mb}MB"
                TOTAL_SIZE=$(( TOTAL_SIZE + size ))
                FILE_COUNT=$(( FILE_COUNT + 1 ))
                BACKUP_FILES="${BACKUP_FILES}$(basename "$file") (${size_mb}MB)\n"
              fi
            done
          fi
          
          TOTAL_SIZE_MB=$(( TOTAL_SIZE / 1024 / 1024 ))
          
          echo "ì´ íŒŒì¼ ìˆ˜: ${FILE_COUNT}ê°œ"
          echo "ì´ í¬ê¸°: ${TOTAL_SIZE_MB}MB"
          
          echo "total_size_mb=${TOTAL_SIZE_MB}" >> $GITHUB_OUTPUT
          echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
          echo "backup_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BACKUP_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: ðŸ” ë°±ì—… ê²€ì¦
        run: |
          echo "ðŸ” ë°±ì—… íŒŒì¼ ê²€ì¦ ì¤‘..."
          
          # JSON íŒŒì¼ ê²€ì¦
          for json_file in backups/json/*.json; do
            if [ -f "$json_file" ]; then
              echo "ê²€ì¦: $(basename "$json_file")"
              
              # JSON íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
              if ! jq empty "$json_file" 2>/dev/null; then
                echo "âŒ JSON íŒŒì¼ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $json_file"
                exit 1
              fi
              
              # í•„ìˆ˜ í•„ë“œ í™•ì¸
              if ! jq -e '.timestamp and .tables' "$json_file" >/dev/null; then
                echo "âŒ JSON ë°±ì—… êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: $json_file"
                exit 1
              fi
              
              table_count=$(jq '.tables | keys | length' "$json_file")
              echo "  âœ… í…Œì´ë¸” ìˆ˜: ${table_count}ê°œ"
            fi
          done
          
          # SQL íŒŒì¼ ê²€ì¦ (ê¸°ë³¸ì ì¸ íŒŒì¼ ì¡´ìž¬ ë° í¬ê¸° í™•ì¸)
          for sql_file in backups/sql/*.sql; do
            if [ -f "$sql_file" ]; then
              echo "ê²€ì¦: $(basename "$sql_file")"
              
              file_size=$(stat -f%z "$sql_file" 2>/dev/null || stat -c%s "$sql_file")
              if [ "$file_size" -lt 1000 ]; then
                echo "âŒ SQL íŒŒì¼ì´ ë„ˆë¬´ ìž‘ìŠµë‹ˆë‹¤: $sql_file (${file_size} bytes)"
                exit 1
              fi
              
              echo "  âœ… íŒŒì¼ í¬ê¸°: $(( file_size / 1024 ))KB"
            fi
          done
          
          echo "âœ… ëª¨ë“  ë°±ì—… íŒŒì¼ ê²€ì¦ ì™„ë£Œ"
      
      - name: ðŸš€ ë°±ì—… ì €ìž¥ì†Œì— ì—…ë¡œë“œ
        env:
          BACKUP_PAT: ${{ secrets.BACKUP_REPO_PAT }}
        run: |
          TIMESTAMP="${{ steps.backup.outputs.backup_timestamp }}"
          BACKUP_REPO_URL="https://${{ secrets.BACKUP_REPO_PAT }}@github.com/${{ github.repository_owner }}/${{ env.BACKUP_REPO }}.git"
          
          echo "ðŸš€ ë°±ì—… íŒŒì¼ì„ ì „ìš© ë¦¬í¬ì§€í† ë¦¬ì— ì—…ë¡œë“œ ì¤‘..."
          
          # ìž„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # ë°±ì—… ë¦¬í¬ì§€í† ë¦¬ í´ë¡  (ë˜ëŠ” ì´ˆê¸°í™”)
          if git clone "$BACKUP_REPO_URL" backup-repo 2>/dev/null; then
            echo "âœ… ê¸°ì¡´ ë°±ì—… ë¦¬í¬ì§€í† ë¦¬ í´ë¡  ì™„ë£Œ"
            cd backup-repo
          else
            echo "ðŸ“ ìƒˆ ë°±ì—… ë¦¬í¬ì§€í† ë¦¬ ì´ˆê¸°í™”"
            mkdir backup-repo && cd backup-repo
            git init
            git remote add origin "$BACKUP_REPO_URL"
            
            # README ìƒì„±
            cat > README.md << 'EOL'
          # ê²Œìž„í”Œë¼ìž ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
          
          ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” ê²Œìž„í”Œë¼ìž ë°ì´í„°ë² ì´ìŠ¤ì˜ ìžë™ ë°±ì—…ì„ ì €ìž¥í•©ë‹ˆë‹¤.
          
          ## êµ¬ì¡°
          - `json/` - JSON í˜•ì‹ ë°±ì—… (Supabase API ì‚¬ìš©)
          - `sql/` - SQL ë¤í”„ ë°±ì—… (pg_dump ì‚¬ìš©)  
          - `logs/` - ë°±ì—… ì‹¤í–‰ ë¡œê·¸
          
          ## ì£¼ì˜ì‚¬í•­
          - ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” ë¹„ê³µê°œë¡œ ìœ ì§€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
          - ë°±ì—… íŒŒì¼ì—ëŠ” ë¯¼ê°í•œ ë°ì´í„°ê°€ í¬í•¨ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤
          - ìžë™í™”ëœ ë°±ì—…ì´ë¯€ë¡œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”
          EOL
            
            git add README.md
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git commit -m "Initial commit"
          fi
          
          # ë°±ì—… íŒŒì¼ ë³µì‚¬
          mkdir -p "json/$TIMESTAMP" "sql/$TIMESTAMP" "logs/$TIMESTAMP"
          
          if [ -d "$GITHUB_WORKSPACE/backups/json" ] && [ "$(ls -A $GITHUB_WORKSPACE/backups/json)" ]; then
            cp -r "$GITHUB_WORKSPACE/backups/json/"* "json/$TIMESTAMP/"
          fi
          
          if [ -d "$GITHUB_WORKSPACE/backups/sql" ] && [ "$(ls -A $GITHUB_WORKSPACE/backups/sql)" ]; then
            cp -r "$GITHUB_WORKSPACE/backups/sql/"* "sql/$TIMESTAMP/"
          fi
          
          if [ -d "$GITHUB_WORKSPACE/backups/logs" ] && [ "$(ls -A $GITHUB_WORKSPACE/backups/logs)" ]; then
            cp -r "$GITHUB_WORKSPACE/backups/logs/"* "logs/$TIMESTAMP/"
          fi
          
          # Git ì»¤ë°‹ ë° í‘¸ì‹œ
          git add .
          
          if git diff --cached --quiet; then
            echo "âš ï¸ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            COMMIT_MESSAGE="ðŸ—„ï¸ Database backup - $TIMESTAMP
            
          ë°±ì—… ì •ë³´:
          - ì‹œê°„: $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')
          - ìœ í˜•: ${{ steps.backup.outputs.backup_type }}
          - íŒŒì¼ ìˆ˜: ${{ steps.backup_info.outputs.file_count }}ê°œ
          - ì´ í¬ê¸°: ${{ steps.backup_info.outputs.total_size_mb }}MB
          - íŠ¸ë¦¬ê±°: ${{ github.event_name }}
          
          ðŸ¤– ìžë™ ë°±ì—… by GitHub Actions"
            
            git commit -m "$COMMIT_MESSAGE"
            git push origin main
            
            echo "âœ… ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ"
          fi
      
      - name: ðŸ§¹ ì˜¤ëž˜ëœ ë°±ì—… ì •ë¦¬
        env:
          BACKUP_PAT: ${{ secrets.BACKUP_REPO_PAT }}
        run: |
          RETENTION_DAYS="${{ github.event.inputs.retention_days || '30' }}"
          BACKUP_REPO_URL="https://${{ secrets.BACKUP_REPO_PAT }}@github.com/${{ github.repository_owner }}/${{ env.BACKUP_REPO }}.git"
          
          echo "ðŸ§¹ ${RETENTION_DAYS}ì¼ ì´ìƒ ëœ ë°±ì—… ì •ë¦¬ ì¤‘..."
          
          # ìž„ì‹œ ë””ë ‰í† ë¦¬ì—ì„œ ë°±ì—… ë¦¬í¬ì§€í† ë¦¬ í´ë¡ 
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          if git clone "$BACKUP_REPO_URL" backup-repo; then
            cd backup-repo
            
            # ì˜¤ëž˜ëœ ë°±ì—… í´ë” ì°¾ê¸° ë° ì‚­ì œ
            CUTOFF_DATE=$(date -d "${RETENTION_DAYS} days ago" +%Y%m%d || date -v -${RETENTION_DAYS}d +%Y%m%d)
            
            DELETED_COUNT=0
            
            for backup_type in json sql logs; do
              if [ -d "$backup_type" ]; then
                for backup_dir in "$backup_type"/*/; do
                  if [ -d "$backup_dir" ]; then
                    dir_name=$(basename "$backup_dir")
                    dir_date=$(echo "$dir_name" | cut -d'_' -f1)
                    
                    if [ ${#dir_date} -eq 8 ] && [ "$dir_date" -lt "$CUTOFF_DATE" ]; then
                      echo "ðŸ—‘ï¸  ì‚­ì œ: $backup_type/$dir_name"
                      rm -rf "$backup_dir"
                      DELETED_COUNT=$((DELETED_COUNT + 1))
                    fi
                  fi
                done
              fi
            done
            
            if [ $DELETED_COUNT -gt 0 ]; then
              git add .
              git config user.name "GitHub Actions"
              git config user.email "actions@github.com"
              git commit -m "ðŸ§¹ ì •ë¦¬: ${DELETED_COUNT}ê°œì˜ ì˜¤ëž˜ëœ ë°±ì—… ì‚­ì œ (${RETENTION_DAYS}ì¼ ì´ìƒ)"
              git push origin main
              echo "âœ… ${DELETED_COUNT}ê°œì˜ ì˜¤ëž˜ëœ ë°±ì—…ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤"
            else
              echo "â„¹ï¸  ì •ë¦¬í•  ì˜¤ëž˜ëœ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤"
            fi
          else
            echo "âš ï¸ ë°±ì—… ë¦¬í¬ì§€í† ë¦¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ì •ë¦¬ ê±´ë„ˆëœ€)"
          fi
      
      - name: ðŸ“Š ë°±ì—… ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "=== ðŸ—„ï¸ ë°±ì—… ì™„ë£Œ ë³´ê³ ì„œ ==="
          echo "â° ì™„ë£Œ ì‹œê°„: $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')"
          echo "ðŸ“ ë°±ì—… ìœ í˜•: ${{ steps.backup.outputs.backup_type }}"
          echo "ðŸ“ˆ ìƒíƒœ: ${{ steps.backup.outputs.backup_status }}"
          echo "ðŸ“„ íŒŒì¼ ìˆ˜: ${{ steps.backup_info.outputs.file_count }}ê°œ"
          echo "ðŸ’¾ ì´ í¬ê¸°: ${{ steps.backup_info.outputs.total_size_mb }}MB"
          echo ""
          echo "ðŸ“‹ ìƒì„±ëœ íŒŒì¼:"
          echo -e "${{ steps.backup_info.outputs.backup_files }}"
          echo ""
          echo "ðŸ”— ë°±ì—… ì €ìž¥ì†Œ: https://github.com/${{ github.repository_owner }}/${{ env.BACKUP_REPO }}"
          
          if [ "${{ steps.backup.outputs.backup_status }}" = "success" ]; then
            echo "âœ… ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ë°±ì—… ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          fi

  # ë°±ì—… ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì )
  notify-failure:
    name: ðŸ“¢ ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: backup
    if: failure()
    
    steps:
      - name: ðŸ“§ ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì )
        run: |
          echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹¤íŒ¨"
          echo "ì‹œê°„: $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S KST')"
          echo "ì›Œí¬í”Œë¡œìš°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "âš ï¸ ê´€ë¦¬ìžê°€ ì¦‰ì‹œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤!"
          
          # ì—¬ê¸°ì— ìŠ¬ëž™, ì´ë©”ì¼, ì›¹í›… ë“± ì•Œë¦¼ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
          # ì˜ˆ: curl -X POST -H 'Content-type: application/json' --data '{"text":"ë°±ì—… ì‹¤íŒ¨!"}' $SLACK_WEBHOOK_URL