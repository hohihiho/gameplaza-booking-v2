<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 실시간 에러 모니터 대시보드</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .status-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.5s ease;
        }

        .status-item.active {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }

        .status-item.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }

        .status-item.warning {
            background: rgba(255, 152, 0, 0.3);
            border: 1px solid #ff9800;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            animation: fadeIn 0.5s ease;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
        }

        .badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .error-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .error-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            position: relative;
            animation: slideIn 0.3s ease;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-item:hover {
            background: rgba(0,0,0,0.3);
            transform: translateX(5px);
        }

        .error-item.fixed {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .error-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-right: 10px;
            font-weight: 600;
        }

        .error-type.runtime { background: #f44336; }
        .error-type.console { background: #ff9800; }
        .error-type.network { background: #2196f3; }
        .error-type.syntax { background: #9c27b0; }
        .error-type.type { background: #3f51b5; }

        .error-message {
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
        }

        .error-location {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .error-time {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.8em;
            opacity: 0.6;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .metric-label {
            font-weight: 600;
        }

        .metric-value {
            font-family: 'Courier New', monospace;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .live-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 5px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            padding: 15px 20px;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            display: none;
        }

        .notification.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: rgba(255,255,255,0.1);
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-chip:hover {
            background: rgba(255,255,255,0.2);
        }

        .filter-chip.active {
            background: #4CAF50;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🚀 실시간 에러 모니터</h1>
            <p>고급 에러 감지 및 자동 수정 시스템</p>
        </header>

        <div class="status-bar">
            <div class="status-item active" id="connection-status">
                <span class="live-indicator"></span>
                <span>연결됨</span>
            </div>
            <div class="status-item" id="autofix-status">
                <span>자동수정: 켜짐</span>
            </div>
            <div class="status-item" id="error-count">
                <span>에러: 0</span>
            </div>
            <div class="status-item" id="fixed-count">
                <span>수정됨: 0</span>
            </div>
        </div>

        <div class="controls">
            <button id="toggle-autofix">자동수정 토글</button>
            <button id="clear-errors">에러 지우기</button>
            <button id="reload-page">페이지 새로고침</button>
            <button id="export-log">로그 내보내기</button>
            <button id="toggle-learning">학습모드: 켜짐</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-errors">0</div>
                <div class="stat-label">총 에러</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errors-per-minute">0</div>
                <div class="stat-label">분당 에러</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fix-rate">100%</div>
                <div class="stat-label">수정률</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="patterns-learned">0</div>
                <div class="stat-label">학습 패턴</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">🔥 실시간 에러</h2>
                    <span class="badge" id="error-badge">0</span>
                </div>
                <div class="filter-bar">
                    <div class="filter-chip active" data-filter="all">전체</div>
                    <div class="filter-chip" data-filter="runtime">런타임</div>
                    <div class="filter-chip" data-filter="console">콘솔</div>
                    <div class="filter-chip" data-filter="network">네트워크</div>
                    <div class="filter-chip" data-filter="type">타입</div>
                </div>
                <div class="error-list" id="error-list">
                    <!-- Errors will be added here -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">📊 성능</h2>
                    <span class="badge">실시간</span>
                </div>
                <div id="performance-metrics">
                    <div class="performance-metric">
                        <span class="metric-label">페이지 로드</span>
                        <span class="metric-value" id="load-time">-</span>
                    </div>
                    <div class="performance-metric">
                        <span class="metric-label">메모리 사용량</span>
                        <span class="metric-value" id="memory-usage">-</span>
                    </div>
                    <div class="performance-metric">
                        <span class="metric-label">FCP</span>
                        <span class="metric-value" id="fcp">-</span>
                    </div>
                    <div class="performance-metric">
                        <span class="metric-label">DOM 준비</span>
                        <span class="metric-value" id="dom-ready">-</span>
                    </div>
                </div>
                <canvas id="performance-chart" class="chart-container"></canvas>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">✅ 수정된 에러</h2>
                    <span class="badge" id="fixed-badge">0</span>
                </div>
                <div class="error-list" id="fixed-list">
                    <!-- Fixed errors will be added here -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">🧠 학습된 패턴</h2>
                    <span class="badge" id="pattern-badge">0</span>
                </div>
                <div id="pattern-list">
                    <!-- Patterns will be added here -->
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        class ErrorDashboard {
            constructor() {
                this.ws = null;
                this.errors = new Map();
                this.fixedErrors = [];
                this.patterns = [];
                this.stats = {
                    total: 0,
                    fixed: 0,
                    errorsPerMinute: 0
                };
                this.autoFix = true;
                this.learning = true;
                this.filter = 'all';
                this.errorTimestamps = [];

                this.init();
            }

            init() {
                this.connectWebSocket();
                this.setupEventListeners();
                this.startStatsUpdater();
            }

            connectWebSocket() {
                this.ws = new WebSocket('ws://localhost:8888');

                this.ws.onopen = () => {
                    console.log('에러 모니터에 연결됨');
                    this.updateConnectionStatus(true);
                    this.ws.send(JSON.stringify({ type: 'query' }));
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onclose = () => {
                    console.log('에러 모니터 연결 끊김');
                    this.updateConnectionStatus(false);
                    // 재연결 시도
                    setTimeout(() => this.connectWebSocket(), 3000);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket 에러:', error);
                };
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'error':
                        this.addError(message.data);
                        break;
                    case 'fixed':
                        this.markFixed(message.data);
                        break;
                    case 'status':
                        this.updateStatus(message.data);
                        break;
                    case 'statistics':
                        this.updateStatistics(message.data);
                        break;
                    case 'performance':
                        this.updatePerformance(message.data);
                        break;
                }
            }

            addError(error) {
                const errorKey = `${error.type}-${error.message}`;

                if (!this.errors.has(errorKey)) {
                    this.errors.set(errorKey, error);
                    this.stats.total++;
                    this.errorTimestamps.push(Date.now());
                    this.renderError(error);
                    this.showNotification(`새로운 ${error.type} 에러 감지`, 'error');
                }

                this.updateStats();
            }

            renderError(error) {
                const errorList = document.getElementById('error-list');
                const errorItem = document.createElement('div');
                errorItem.className = `error-item ${error.type}`;
                errorItem.dataset.type = error.type;
                errorItem.innerHTML = `
                    <span class="error-type ${error.type}">${error.type.toUpperCase()}</span>
                    <span class="error-time">${this.formatTime(error.timestamp)}</span>
                    <div class="error-message">${this.escapeHtml(error.message)}</div>
                    ${error.source ? `<div class="error-location">📍 ${error.source}:${error.lineNumber || '?'}:${error.columnNumber || '?'}</div>` : ''}
                `;

                errorItem.onclick = () => this.showErrorDetails(error);

                if (this.filter === 'all' || this.filter === error.type) {
                    errorItem.style.display = 'block';
                } else {
                    errorItem.style.display = 'none';
                }

                errorList.insertBefore(errorItem, errorList.firstChild);
                this.updateBadge('error-badge', this.errors.size);
            }

            markFixed(error) {
                const errorKey = `${error.type}-${error.message}`;
                if (this.errors.has(errorKey)) {
                    this.errors.delete(errorKey);
                    this.fixedErrors.push(error);
                    this.stats.fixed++;

                    // UI 업데이트
                    const errorItems = document.querySelectorAll('.error-item');
                    errorItems.forEach(item => {
                        if (item.textContent.includes(error.message)) {
                            item.classList.add('fixed');
                            setTimeout(() => item.remove(), 1000);
                        }
                    });

                    this.renderFixedError(error);
                    this.showNotification('에러가 자동으로 수정되었습니다!', 'success');
                }

                this.updateStats();
            }

            renderFixedError(error) {
                const fixedList = document.getElementById('fixed-list');
                const fixedItem = document.createElement('div');
                fixedItem.className = 'error-item fixed';
                fixedItem.innerHTML = `
                    <span class="error-type ${error.type}">${error.type.toUpperCase()}</span>
                    <span class="error-time">${this.formatTime(Date.now())}</span>
                    <div class="error-message">${this.escapeHtml(error.message)}</div>
                `;

                fixedList.insertBefore(fixedItem, fixedList.firstChild);
                this.updateBadge('fixed-badge', this.fixedErrors.length);
            }

            updateStats() {
                // 총 에러 수
                document.getElementById('total-errors').textContent = this.stats.total;
                document.getElementById('error-count').textContent = `에러: ${this.errors.size}`;
                document.getElementById('fixed-count').textContent = `수정됨: ${this.stats.fixed}`;

                // 분당 에러 계산
                const now = Date.now();
                const recentErrors = this.errorTimestamps.filter(t => now - t < 60000);
                document.getElementById('errors-per-minute').textContent = recentErrors.length;

                // 수정률 계산
                const fixRate = this.stats.total > 0
                    ? Math.round((this.stats.fixed / this.stats.total) * 100)
                    : 100;
                document.getElementById('fix-rate').textContent = `${fixRate}%`;
            }

            updatePerformance(data) {
                if (data.loadTime) {
                    document.getElementById('load-time').textContent = `${data.loadTime}ms`;
                }
                if (data.memory) {
                    const memoryMB = (data.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                    document.getElementById('memory-usage').textContent = `${memoryMB}MB`;
                }
                if (data.firstContentfulPaint) {
                    document.getElementById('fcp').textContent = `${data.firstContentfulPaint}ms`;
                }
                if (data.domContentLoaded) {
                    document.getElementById('dom-ready').textContent = `${data.domContentLoaded}ms`;
                }
            }

            setupEventListeners() {
                // Auto-fix toggle
                document.getElementById('toggle-autofix').onclick = () => {
                    this.autoFix = !this.autoFix;
                    const btn = document.getElementById('toggle-autofix');
                    btn.classList.toggle('active', this.autoFix);
                    document.getElementById('autofix-status').textContent = `자동수정: ${this.autoFix ? '켜짐' : '꺼짐'}`;

                    this.ws.send(JSON.stringify({
                        type: 'command',
                        command: this.autoFix ? 'resume' : 'pause'
                    }));
                };

                // Clear errors
                document.getElementById('clear-errors').onclick = () => {
                    this.errors.clear();
                    document.getElementById('error-list').innerHTML = '';
                    this.updateBadge('error-badge', 0);

                    this.ws.send(JSON.stringify({
                        type: 'command',
                        command: 'clear'
                    }));
                };

                // Reload page
                document.getElementById('reload-page').onclick = () => {
                    this.ws.send(JSON.stringify({
                        type: 'command',
                        command: 'reload'
                    }));
                };

                // Export log
                document.getElementById('export-log').onclick = () => {
                    const log = {
                        errors: Array.from(this.errors.values()),
                        fixed: this.fixedErrors,
                        patterns: this.patterns,
                        stats: this.stats,
                        timestamp: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(log, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `error-log-${Date.now()}.json`;
                    a.click();
                };

                // Learning mode toggle
                document.getElementById('toggle-learning').onclick = () => {
                    this.learning = !this.learning;
                    const btn = document.getElementById('toggle-learning');
                    btn.textContent = `학습모드: ${this.learning ? '켜짐' : '꺼짐'}`;
                    btn.classList.toggle('active', this.learning);
                };

                // Filters
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.onclick = () => {
                        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                        chip.classList.add('active');
                        this.filter = chip.dataset.filter;
                        this.applyFilter();
                    };
                });
            }

            applyFilter() {
                const errorItems = document.querySelectorAll('.error-item');
                errorItems.forEach(item => {
                    if (this.filter === 'all' || item.dataset.type === this.filter) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            startStatsUpdater() {
                setInterval(() => {
                    this.ws.send(JSON.stringify({
                        type: 'command',
                        command: 'stats'
                    }));
                }, 5000);
            }

            updateConnectionStatus(connected) {
                const status = document.getElementById('connection-status');
                if (connected) {
                    status.classList.add('active');
                    status.innerHTML = '<span class="live-indicator"></span><span>연결됨</span>';
                } else {
                    status.classList.remove('active');
                    status.classList.add('error');
                    status.innerHTML = '<span>연결 끊김</span>';
                }
            }

            updateBadge(id, count) {
                document.getElementById(id).textContent = count;
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification show ${type}`;

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            showErrorDetails(error) {
                console.log('에러 상세정보:', error);
                // 여기에 상세 정보 모달 구현
            }

            formatTime(timestamp) {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                return date.toLocaleTimeString('ko-KR');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateStatistics(data) {
                if (data.patterns) {
                    document.getElementById('patterns-learned').textContent = data.patterns;
                }
            }

            updateStatus(data) {
                if (data.errors) {
                    this.errors.clear();
                    data.errors.forEach(error => {
                        this.errors.set(`${error.type}-${error.message}`, error);
                        this.renderError(error);
                    });
                }

                if (data.fixes) {
                    this.fixedErrors = data.fixes;
                    data.fixes.forEach(fix => this.renderFixedError(fix.error));
                }

                if (data.performance && data.performance.length > 0) {
                    const latest = data.performance[data.performance.length - 1];
                    this.updatePerformance(latest[1]);
                }

                this.updateStats();
            }
        }

        // 대시보드 시작
        const dashboard = new ErrorDashboard();
    </script>
</body>
</html>