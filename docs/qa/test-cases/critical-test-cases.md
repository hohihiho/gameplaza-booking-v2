# 🚨 크리티컬 테스트 케이스

> **목표**: 크리티컬 버그 0개 - 시스템 중단이나 데이터 손실이 절대 발생하지 않도록 보장

## 📋 문서 개요

이 문서는 시스템의 안정성과 데이터 무결성을 보장하기 위한 **크리티컬 테스트 케이스**를 정의합니다.
모든 크리티컬 테스트는 **반드시 통과**해야 하며, 하나라도 실패하면 배포가 불가능합니다.

## 🎯 크리티컬 영역 정의

### 1. 데이터 무결성
- 예약 데이터의 정확성과 일관성
- 트랜잭션 처리의 원자성
- 참조 무결성 보장

### 2. 결제 정확성
- 금액 계산의 100% 정확도
- 결제 상태의 일관성
- 환불 처리의 정확성

### 3. 보안 취약점
- 인증/인가 우회 방지
- 데이터 유출 방지
- 악의적 공격 차단

### 4. 시스템 가용성
- 서비스 중단 방지
- 장애 복구 능력
- 성능 저하 방지

---

## 💾 1. 데이터 무결성 테스트

### 1.1 예약 중복 방지

#### **TC-C001: 동시 예약 트랜잭션 처리**
```typescript
테스트 시나리오:
1. 10명의 사용자가 동시에 같은 시간대/기기 예약
2. 각각 다른 세션에서 동시 요청
3. 데이터베이스 트랜잭션 경합 발생

검증 항목:
- ✅ 단 1건의 예약만 성공
- ✅ 나머지 9건은 적절한 오류 메시지
- ✅ 데이터베이스에 중복 레코드 없음
- ✅ 예약 번호(YYMMDD-NNN) 중복 없음

임계값: 100% 성공률 (1000회 반복 테스트)
```

#### **TC-C002: 트랜잭션 롤백 완전성**
```typescript
테스트 시나리오:
1. 예약 생성 중 다양한 단계에서 오류 주입
2. 결제 처리 중 네트워크 오류
3. 상태 변경 중 시스템 오류

검증 항목:
- ✅ 부분적으로 생성된 데이터 없음
- ✅ 관련 테이블 간 일관성 유지
- ✅ 시퀀스 번호 낭비 없음
- ✅ 오류 발생 전 상태로 완전 복구

임계값: 롤백 성공률 100%
```

#### **TC-C003: 참조 무결성 검증**
```typescript
테스트 시나리오:
1. 사용자 삭제 시 예약 데이터 처리
2. 기기 삭제 시 예약 데이터 처리
3. 시간대 변경 시 예약 영향도

검증 항목:
- ✅ 고아 레코드 생성 방지
- ✅ CASCADE 규칙 정확히 동작
- ✅ 소프트 삭제 시 데이터 보존
- ✅ 하드 삭제 제한 동작

임계값: 무결성 위반 0건
```

### 1.2 시간 데이터 정확성

#### **TC-C004: 06시 영업일 리셋 정확성**
```typescript
테스트 시나리오:
1. 05:59에 예약 생성 → 전일 영업일
2. 06:00에 예약 생성 → 당일 영업일
3. 00:00~05:59 시간대 처리

검증 항목:
- ✅ 영업일 경계 정확히 06:00
- ✅ 통계 집계 정확성
- ✅ 일일 매출 계산 정확성
- ✅ 예약 번호 날짜 부분 정확성

임계값: 100% 정확도
```

#### **TC-C005: KST 시간대 일관성**
```typescript
테스트 시나리오:
1. 서버 시간대 변경 시도
2. 클라이언트 시간대 조작
3. UTC/KST 변환 처리

검증 항목:
- ✅ 모든 시간 데이터 KST 고정
- ✅ 시간대 변환 오류 없음
- ✅ 24시간 룰 정확히 계산
- ✅ DB 저장 시간 일관성

임계값: 시간 오차 0초
```

---

## 💰 2. 결제 정확성 테스트

### 2.1 금액 계산

#### **TC-C006: 가격 계산 정확성**
```typescript
테스트 시나리오:
1. 다양한 크레딧 타입별 가격
2. 시간별 차등 요금
3. 2인 플레이 추가 요금
4. 할인/프로모션 적용

검증 항목:
- ✅ 모든 경우의 수 정확한 계산
- ✅ 부동소수점 오차 없음
- ✅ 음수 금액 방지
- ✅ 최종 금액 일관성

임계값: 계산 오차 0원
```

#### **TC-C007: 시간/금액 조정 트랜잭션**
```typescript
테스트 시나리오:
1. 관리자가 금액 조정
2. 동시에 결제 상태 변경
3. 조정 중 시스템 오류

검증 항목:
- ✅ 조정 이력 완전 기록
- ✅ 원본 데이터 보존
- ✅ 조정 사유 필수 입력
- ✅ 트랜잭션 일관성

임계값: 데이터 손실 0건
```

### 2.2 결제 상태 관리

#### **TC-C008: 결제 상태 전이 무결성**
```typescript
테스트 시나리오:
1. 대기 → 체크인 → 결제완료
2. 비정상적인 상태 전이 시도
3. 동시 상태 변경 요청

검증 항목:
- ✅ 허용된 상태 전이만 가능
- ✅ 상태 변경 이력 추적
- ✅ 중간 상태 누락 없음
- ✅ 동시성 충돌 해결

임계값: 비정상 전이 0건
```

#### **TC-C009: 환불 처리 정확성**
```typescript
테스트 시나리오:
1. 전액 환불 처리
2. 부분 환불 처리
3. 중복 환불 시도
4. 환불 후 재결제

검증 항목:
- ✅ 환불 금액 정확성
- ✅ 원 거래 참조 유지
- ✅ 중복 환불 방지
- ✅ 환불 이력 완전성

임계값: 환불 오류 0건
```

---

## 🔐 3. 보안 취약점 테스트

### 3.1 인증/인가

#### **TC-C010: 권한 우회 방지**
```typescript
테스트 시나리오:
1. JWT 토큰 조작
2. 관리자 API 직접 호출
3. RLS 정책 우회 시도
4. 세션 하이재킹

검증 항목:
- ✅ 모든 권한 검증 통과
- ✅ 토큰 변조 감지
- ✅ RLS 100% 적용
- ✅ 세션 보안 유지

임계값: 우회 성공 0건
```

#### **TC-C011: 데이터 접근 제어**
```typescript
테스트 시나리오:
1. 타 사용자 데이터 접근 시도
2. 삭제된 데이터 접근
3. 권한 없는 수정 시도

검증 항목:
- ✅ 본인 데이터만 접근
- ✅ 삭제 데이터 차단
- ✅ 읽기 전용 준수
- ✅ 관리자 권한 정확성

임계값: 비인가 접근 0건
```

### 3.2 입력 검증

#### **TC-C012: SQL Injection 방어**
```typescript
테스트 데이터:
- "'; DROP TABLE users; --"
- "1' OR '1'='1"
- "admin'/**/AND/**/1=1#"
- Unicode 인코딩 공격

검증 항목:
- ✅ 모든 입력 이스케이프
- ✅ Prepared Statement 사용
- ✅ 쿼리 실행 차단
- ✅ 에러 정보 노출 없음

임계값: 공격 성공 0건
```

#### **TC-C013: XSS 공격 차단**
```typescript
테스트 데이터:
- "<script>alert('XSS')</script>"
- "javascript:void(0)"
- "<img src=x onerror=alert(1)>"
- SVG/CSS 기반 XSS

검증 항목:
- ✅ HTML 엔티티 인코딩
- ✅ CSP 헤더 적용
- ✅ 스크립트 실행 차단
- ✅ 안전한 렌더링

임계값: XSS 실행 0건
```

---

## 🏥 4. 시스템 가용성 테스트

### 4.1 장애 복구

#### **TC-C014: 데이터베이스 연결 복구**
```typescript
테스트 시나리오:
1. DB 연결 일시 중단
2. 연결 풀 고갈
3. 네트워크 타임아웃
4. DB 재시작

검증 항목:
- ✅ 자동 재연결 동작
- ✅ 연결 풀 복구
- ✅ 트랜잭션 재시도
- ✅ 사용자 영향 최소화

임계값: 복구 시간 30초 이내
```

#### **TC-C015: 메모리 누수 방지**
```typescript
테스트 시나리오:
1. 24시간 연속 운영
2. 대량 요청 처리
3. WebSocket 연결 누적
4. 캐시 메모리 증가

검증 항목:
- ✅ 메모리 사용량 안정
- ✅ GC 정상 동작
- ✅ 리소스 해제 확인
- ✅ OOM 에러 없음

임계값: 메모리 누수 0MB/hour
```

### 4.2 성능 임계값

#### **TC-C016: 응답 시간 보장**
```typescript
테스트 시나리오:
1. 동시 사용자 100명
2. 초당 요청 1000건
3. 대용량 데이터 조회
4. 복잡한 집계 쿼리

검증 항목:
- ✅ API 응답 < 3초
- ✅ 페이지 로드 < 5초
- ✅ DB 쿼리 < 1초
- ✅ 타임아웃 없음

임계값: SLA 99.9% 달성
```

#### **TC-C017: 동시성 처리 능력**
```typescript
테스트 시나리오:
1. 동시 예약 100건
2. 실시간 업데이트 1000건
3. 대량 체크인 처리
4. 피크 시간 부하

검증 항목:
- ✅ 데드락 발생 없음
- ✅ 경쟁 조건 해결
- ✅ 처리량 유지
- ✅ 오류율 < 0.1%

임계값: 동시성 오류 0건
```

---

## 🔥 5. 핵심 비즈니스 로직 테스트

### 5.1 24시간 룰 엔진

#### **TC-C018: 24시간 제한 정확성**
```typescript
테스트 시나리오:
1. 정확히 24시간 경계선
2. 서머타임 전환 시점
3. 윤초 발생 시점
4. 시스템 시간 조작

검증 항목:
- ✅ 밀리초 단위 정확성
- ✅ 시간대 변화 대응
- ✅ 엣지 케이스 처리
- ✅ 우회 불가능

임계값: 오차 0초
```

#### **TC-C019: 예약 충돌 엔진**
```typescript
테스트 시나리오:
1. 시간 중첩 검사
2. 기기 상태 변경
3. 동적 시간대 생성
4. 취소 후 재예약

검증 항목:
- ✅ 모든 충돌 감지
- ✅ 실시간 상태 반영
- ✅ 트랜잭션 보장
- ✅ 경쟁 조건 해결

임계값: 충돌 누락 0건
```

### 5.2 실시간 동기화

#### **TC-C020: WebSocket 안정성**
```typescript
테스트 시나리오:
1. 연결 끊김/재연결
2. 메시지 순서 보장
3. 대량 브로드캐스트
4. 연결 수 제한

검증 항목:
- ✅ 자동 재연결
- ✅ 메시지 손실 없음
- ✅ 순서 보장
- ✅ 메모리 안정성

임계값: 메시지 손실 0%
```

---

## 📊 테스트 실행 가이드

### 실행 우선순위

1. **🔴 Immediate (배포 차단)**
   - 데이터 무결성 테스트
   - 결제 정확성 테스트
   - 보안 취약점 테스트

2. **🟠 Critical (24시간 내)**
   - 시스템 가용성 테스트
   - 핵심 비즈니스 로직

3. **🟡 Important (주간)**
   - 성능 임계값 테스트
   - 장애 복구 테스트

### 자동화 설정

```bash
# 크리티컬 테스트 스위트 실행
npm run test:critical

# 특정 영역만 테스트
npm run test:critical -- --grep "데이터 무결성"

# CI/CD 파이프라인 통합
npm run test:critical:ci
```

### 실패 시 대응

1. **즉시 배포 중단**
2. **긴급 패치 적용**
3. **전체 회귀 테스트**
4. **포스트모템 작성**

---

## 📈 모니터링 및 알림

### 실시간 모니터링
- Sentry: 에러 추적
- Datadog: 성능 메트릭
- PagerDuty: 긴급 알림

### 임계값 알림
- 응답 시간 > 3초
- 에러율 > 0.1%
- 메모리 사용률 > 80%
- DB 연결 실패

---

## 🚨 비상 대응 프로토콜

### Level 1: 경고
- 성능 저하 감지
- 에러율 상승
- 대응: 모니터링 강화

### Level 2: 위험
- 일부 기능 장애
- 데이터 불일치 감지
- 대응: 긴급 패치

### Level 3: 크리티컬
- 서비스 중단
- 데이터 손실 위험
- 대응: 롤백 및 복구

---

⚠️ **중요**: 크리티컬 테스트는 100% 통과해야 배포 가능합니다.

*마지막 업데이트: 2025-07-25*
*담당: QA Team & DevOps Team*