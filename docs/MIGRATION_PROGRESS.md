# Cloudflare D1 ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ìƒí™©

> ì‘ì„±ì¼: 2025-09-09
> ì‘ì„±ì: Claude (with Seehee Jang)

## ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°œìš”

ê²Œì„í”Œë¼ì ì˜ˆì•½ ì‹œìŠ¤í…œì„ Supabaseì—ì„œ Cloudflare D1ìœ¼ë¡œ ì™„ì „íˆ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ ë³€ê²½
| êµ¬ë¶„ | ì´ì „ (Supabase) | í˜„ì¬ (Cloudflare) |
|------|----------------|-------------------|
| **ë°ì´í„°ë² ì´ìŠ¤** | Supabase (PostgreSQL) | Cloudflare D1 (SQLite) |
| **ì¸ì¦** | NextAuth + Stack Auth | Better Auth |
| **ì—£ì§€ í•¨ìˆ˜** | Supabase Edge Functions | Cloudflare Workers |
| **íŒŒì¼ ì €ì¥** | Supabase Storage | Cloudflare R2 |
| **ì„¸ì…˜ ì €ì¥** | PostgreSQL | Cloudflare KV |
| **ë°°í¬** | Vercel Only | Vercel (Frontend) + Cloudflare (API) |

## âœ… ì™„ë£Œëœ ì‘ì—… (2025-09-09)

### 1. í™˜ê²½ ì„¤ì •
- [x] Cloudflare Workers í™˜ê²½ êµ¬ì„± (`wrangler.toml`)
- [x] D1 ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
  - Production: `gameplaza-production` (ID: 1d59afcb-f4c2-4d1c-9532-a63bd124bf97)
  - Development: `gameplaza-development` (ID: d8bb6ff7-b731-4d5a-b22f-4b3e41c9ed8e)
- [x] KV ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„¤ì • (ì„¸ì…˜ ì €ì¥ìš©)
- [x] R2 ë²„í‚· ì„¤ì • (íŒŒì¼ ì €ì¥ìš©)

### 2. í™˜ê²½ ë³€ìˆ˜ ë§ˆì´ê·¸ë ˆì´ì…˜
- [x] `.env.production` ì—…ë°ì´íŠ¸
  - Supabase ê´€ë ¨ ë³€ìˆ˜ ì œê±°
  - D1/Better Auth ë³€ìˆ˜ ì¶”ê°€
- [x] `.dev.vars` ìƒì„± (Cloudflare Workers ê°œë°œ í™˜ê²½)
- [x] Stack Auth í”Œë ˆì´ìŠ¤í™€ë” ì œê±°

### 3. ì¸ì¦ ì‹œìŠ¤í…œ ë³€ê²½
- [x] Better Auth íŒ¨í‚¤ì§€ ì„¤ì¹˜
- [x] Better Auth ì„¤ì • íŒŒì¼ ìƒì„± (`lib/better-auth.ts`)
- [x] Google OAuth ì„¤ì • ë§ˆì´ê·¸ë ˆì´ì…˜
- [x] ì„¸ì…˜ ê´€ë¦¬ ì„¤ì • (KV ìŠ¤í† ì–´ ì‚¬ìš©)

### 4. D1 ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
- [x] D1 í´ë¼ì´ì–¸íŠ¸ ì½”ì–´ (`lib/d1/client.ts`)
- [x] ì¿¼ë¦¬ ë¹Œë” í—¬í¼ í•¨ìˆ˜
- [x] ë¦¬í¬ì§€í† ë¦¬ íŒ¨í„´ êµ¬í˜„:
  - `lib/d1/repositories/users.ts` - ì‚¬ìš©ì ê´€ë¦¬
  - `lib/d1/repositories/devices.ts` - ê¸°ê¸° ê´€ë¦¬
  - `lib/d1/repositories/reservations.ts` - ì˜ˆì•½ ê´€ë¦¬
  - `lib/d1/repositories/admins.ts` - ê´€ë¦¬ì ê¶Œí•œ ê´€ë¦¬

### 5. í”„ë¡œì íŠ¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [x] ê¸°íšì„œ ì—…ë°ì´íŠ¸ (`docs/planning/complete_specification.md`)
  - Supabase ì°¸ì¡° ì œê±°
  - Cloudflare D1/Better Auth ë°˜ì˜
- [x] Cloudflare ë°°í¬ ê°€ì´ë“œ ìƒì„± (`docs/CLOUDFLARE_DEPLOYMENT.md`)

### 6. ë²„ê·¸ ìˆ˜ì •
- [x] ì´ìƒí•œ íŒŒì¼ëª… íŒ¨í„´ (`.!ìˆ«ì!`) íŒŒì¼ ëª¨ë‘ ì‚­ì œ
- [x] Stack Auth ì¤‘ë³µ import ì˜¤ë¥˜ ìˆ˜ì •
- [x] Next.js ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°

## ğŸš§ ì§„í–‰ ì¤‘ì¸ ì‘ì—…

### API ì—”ë“œí¬ì¸íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] `/api/auth/*` - Better Authë¡œ ë³€ê²½
- [ ] `/api/devices/*` - D1 ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©
- [ ] `/api/reservations/*` - D1 ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©
- [ ] `/api/admin/*` - D1 ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©

### Supabase ì˜ì¡´ì„± ì œê±°
- [ ] `lib/supabase/*` íŒŒì¼ ì œê±°
- [ ] ì»´í¬ë„ŒíŠ¸ì—ì„œ Supabase í´ë¼ì´ì–¸íŠ¸ ì°¸ì¡° ì œê±°
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì—…ë°ì´íŠ¸

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„ (TODO)

1. **Supabase ì½”ë“œ ì™„ì „ ì œê±°**
   - `lib/supabase` í´ë” ì‚­ì œ
   - ëª¨ë“  import ë¬¸ ë³€ê²½
   - Supabase ê´€ë ¨ íƒ€ì… ì •ì˜ ì œê±°

2. **API ë¼ìš°íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜**
   - D1 ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
   - Better Auth ë¯¸ë“¤ì›¨ì–´ ì ìš©
   - ì—ëŸ¬ í•¸ë“¤ë§ ì—…ë°ì´íŠ¸

3. **í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸**
   - useUser Hookì„ Better Authìš©ìœ¼ë¡œ ë³€ê²½
   - ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í”Œë¡œìš° ì—…ë°ì´íŠ¸
   - ì‹¤ì‹œê°„ ê¸°ëŠ¥ ì¬êµ¬í˜„ (í•„ìš”ì‹œ)

4. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**
   - ë¡œì»¬ ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸
   - Cloudflare Workers ë°°í¬ í…ŒìŠ¤íŠ¸
   - ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
   - ë³´ì•ˆ ê²€ì¦

5. **ë°°í¬ ì¤€ë¹„**
   - GitHub Actions ì›Œí¬í”Œë¡œìš° ì—…ë°ì´íŠ¸
   - Vercel í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
   - Cloudflare Workers ì‹œí¬ë¦¿ ì„¤ì •
   - ëª¨ë‹ˆí„°ë§ ì„¤ì •

## ğŸ” ì£¼ìš” ë³€ê²½ ì‚¬í•­ ìƒì„¸

### D1 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆëŠ” D1 ìŠ¤í‚¤ë§ˆë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©:
- users í…Œì´ë¸”
- devices í…Œì´ë¸”
- reservations í…Œì´ë¸”
- admins í…Œì´ë¸”
- ê¸°íƒ€ í•„ìš” í…Œì´ë¸”ë“¤

### Better Auth ì„¤ì •
```typescript
// lib/better-auth.ts
- Google OAuth ì§€ì›
- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦
- ì„¸ì…˜ ê´€ë¦¬ (7ì¼ ìœ íš¨)
- Rate Limiting ì ìš©
```

### Cloudflare Workers ì„¤ì •
```toml
# wrangler.toml
- D1 ë°ì´í„°ë² ì´ìŠ¤ ë°”ì¸ë”©
- KV ë„¤ì„ìŠ¤í˜ì´ìŠ¤ (ì„¸ì…˜)
- R2 ë²„í‚· (íŒŒì¼)
- í™˜ê²½ë³„ ì„¤ì • (dev/staging/prod)
```

## ğŸ“Š ì§„í–‰ë¥ 

**ì „ì²´ ì§„í–‰ë¥ : 60%**

- [x] í™˜ê²½ ì„¤ì • (100%)
- [x] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (100%)
- [x] ì¸ì¦ ì‹œìŠ¤í…œ ì„¤ì • (100%)
- [ ] API ì—”ë“œí¬ì¸íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜ (0%)
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸ (0%)
- [ ] í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ (0%)
- [ ] ë°°í¬ ì¤€ë¹„ (0%)

## ğŸ’¡ ì¤‘ìš” ì‚¬í•­

1. **D1 ì œí•œ ì‚¬í•­**
   - SQLite ê¸°ë°˜ì´ë¯€ë¡œ PostgreSQL íŠ¹ì • ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€
   - íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë°©ì‹ ì°¨ì´
   - JSON íƒ€ì… ëŒ€ì‹  TEXTë¡œ ì €ì¥

2. **Better Auth ì¥ì **
   - Edge í™˜ê²½ ìµœì í™”
   - íƒ€ì… ì•ˆì •ì„±
   - ë‹¤ì–‘í•œ OAuth ì œê³µì ì§€ì›
   - ìì²´ ì„¸ì…˜ ê´€ë¦¬

3. **ì„±ëŠ¥ ê°œì„  ì˜ˆìƒ**
   - Edgeì—ì„œ ì‹¤í–‰ë˜ì–´ ì§€ì—° ì‹œê°„ ê°ì†Œ
   - KV ì„¸ì…˜ìœ¼ë¡œ ë¹ ë¥¸ ì¸ì¦
   - R2 ì •ì  íŒŒì¼ ì œê³µ ìµœì í™”

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [Cloudflare D1 ë¬¸ì„œ](https://developers.cloudflare.com/d1/)
- [Better Auth ë¬¸ì„œ](https://www.better-auth.com/)
- [Wrangler CLI ë¬¸ì„œ](https://developers.cloudflare.com/workers/wrangler/)
- [í”„ë¡œì íŠ¸ ê¸°íšì„œ](./planning/complete_specification.md)
- [Cloudflare ë°°í¬ ê°€ì´ë“œ](./CLOUDFLARE_DEPLOYMENT.md)

## ğŸ“ ì»¤ë°‹ ì´ë ¥

- `6467e8a` - feat: Supabaseì—ì„œ Cloudflare D1ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

---

*ì´ ë¬¸ì„œëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰ ìƒí™©ì„ ì¶”ì í•˜ê¸° ìœ„í•´ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ì‘ì—…ì´ ì§„í–‰ë¨ì— ë”°ë¼ ì§€ì†ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*